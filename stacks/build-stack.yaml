configs:
  buildkitd-config:
    buildkitd.toml: |
      debug=true
      [gc]
        enabled=false
      [worker.oci]
        enabled=true
        gc=false
        gckeepstorage=1073741824
      [grpc]
        address = [ "tcp://0.0.0.0:8080" ]
        # debugAddress is address for attaching go profiles and debuggers.
        debugAddress = "0.0.0.0:6060"

kubernetes:
  manifest: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: webhook
      namespace: ${NAMESPACE}
      labels:
        app: webhook
        version: v0
    spec:
      selector:
        matchLabels:
          app: webhook
          version: v0
      template:
        metadata:
          labels:
            app: webhook
            version: v0
        spec:
          containers:
            - args:
                - gitwatcher
                - --listen-address
                - :8090
              image: rancher/gitwatcher:v0.4.5
              imagePullPolicy: Always
              name: webhook
              ports:
                - containerPort: 8090
                  name: http-webhook
                  protocol: TCP

# TODO: add below back in, buildkitd needs rewritten and gitwatcher needs its permissions back
#
#deploymentwranglers:
#  buildkitd:
#    version: v0
#    serviceMesh: false
#    image: "moby/buildkit:v0.6.1"
#    ports:
#    - 8080/http,buildkit,expose=false
#    privileged: true
#    configs:
#    - buildkitd-config:/etc/buildkit
#    containers:
#    - name: registry
#      image: "registry:2"
#      env:
#      - REGISTRY_HTTP_ADDR=0.0.0.0:80
#      ports:
#      - 80:80/tcp,registry,expose=false
#      volume:
#      - rio-registry:/var/lib/registry,persistent=${PERSISTENT}
  webhook:
    version: v0
    global_permissions:
    - "* gitwatcher.cattle.io/gitwatchers"
    - "* gitwatcher.cattle.io/gitcommits"
    - '* configmaps'
    - '* events'
    - get,list pods
    - create,get,list /pods/log
    - secrets

template:
  envSubst: true
  questions:
  - variable: PERSISTENT
    description: "Use PV to store registry data"
